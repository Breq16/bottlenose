run_on_page("assignments/show", toggles_init);

function toggles_init() {
  $('.toggle-wrapper').click(function(e) {
    e.stopPropagation(); // calling bootstrapToggle on the toggle itself fires the 'change' event, so the wrapper is necessary to change the toggle's value without firing the event
    var toggle = $(this).find('.submission-enabled-toggle')[0];
    var toggleId = $(toggle).data("stid");
    var data = {state: !toggle.checked}; // attempt to flip
    function complete(xhr, status) {
      if (xhr.status == 409) {
        alert("That section was toggled by another user. Toggles have been updated to match the current state.");
        $.each(xhr.responseJSON, function(index, newState) {
          var sel = '.submission-enabled-toggle#allow-' + newState.id;
          $(sel).bootstrapToggle(newState.state);
        });
      } else if (xhr.status == 200) {
        // successfully changed the state
        $(toggle).bootstrapToggle('toggle'); // display success to user
      } else {
        alert("Error (" + xhr.status + ") while trying to change section toggle.");
        toggle.bootstrapToggle('toggle'); // set it back because of the error
      }
    }
    var baseUrl = "<%= course_assignment_submission_enabled_toggle_update_path(assignment_id: @assignment.id, course_id: @course.id, submission_enabled_toggle_id: '(setid)') %>";
    var url = baseUrl.replace('(setid)', toggleId);
    $.ajax({url: url, data: data, type: 'PATCH', complete: complete});
  });
}
